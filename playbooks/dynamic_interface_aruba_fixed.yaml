---
###############################################################################
# PLAY 1 — Resolve switch and port
###############################################################################
- name: Resolve switch and port
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../vars/switch_mapping.yml
    - ../vars/wall_point_mapping.yml
    - ../vars/interface_name.yml
    - ../vars/vlan_mapping.yml
    - ../vars/switch_ip_mapping.yml

  tasks:
    - name: Resolve switch from room
      set_fact:
        switch_name: "{{ item.key }}"
      loop: "{{ switch_mapping | dict2items }}"
      when: room | lower in (item.value | map('lower') | list)

    - name: Fail if switch not resolved
      fail:
        msg: "No switch found for room {{ room }}"
      when: switch_name is not defined

    - name: Resolve actual port number
      set_fact:
        actual_port_number: >-
          {{
            wall_point_mapping[port_number]
            if port_number in wall_point_mapping
            else port_number
          }}

    - name: Build interface description
      set_fact:
        interface_description: "N-G-06_Corner_Office_{{ device_type }}"

    - name: Add resolved switch to runtime inventory
      add_host:
        name: "{{ switch_name }}"
        groups: dynamic_switches
        ansible_host: "{{ switch_ip_mapping[switch_name] }}"
        ansible_port_number: "{{ actual_port_number }}"
        ansible_device_type: "{{ device_type }}"
        ansible_second_device_type: "{{ second_device_type | default('none') }}"
        interface_description: "{{ interface_description }}"

    - debug:
        msg:
          - "Switch: {{ switch_name }}"
          - "IP: {{ switch_ip_mapping[switch_name] }}"
          - "Port: {{ actual_port_number }}"
          - "Description: {{ interface_description }}"

###############################################################################
# PLAY 2 — Configure Aruba switch port (SUPPORTED COMMANDS ONLY)
###############################################################################
- name: Configure Aruba switch port (FINAL WORKING)
  hosts: dynamic_switches
  gather_facts: false
  connection: network_cli

  collections:
    - community.network

  vars_files:
    - ../vars/vlan_mapping.yml

  tasks:
    ###########################################################################
    # READ CURRENT CONFIG
    ###########################################################################
    - name: Read current interface config
      community.network.aruba_command:
        commands:
          - "show running-config interface {{ ansible_port_number }}"
      register: iface_before

    - debug:
        var: iface_before.stdout[0]

    ###########################################################################
    # CLEAN VLAN STATE
    ###########################################################################
    - name: Ensure interface enabled
      community.network.aruba_config:
        parents: "interface {{ ansible_port_number }}"
        lines:
          - "enable"

    - name: Remove existing VLANs
      community.network.aruba_config:
        parents: "interface {{ ansible_port_number }}"
        lines:
          - "no untagged vlan"
          - "no tagged vlan"
      ignore_errors: true

    ###########################################################################
    # APPLY DEVICE CONFIG
    ###########################################################################
    - name: Apply non-phone device config
      when:
        - ansible_device_type != "phone"
        - ansible_device_type != "none"
      community.network.aruba_config:
        parents: "interface {{ ansible_port_number }}"
        lines:
          - "name {{ interface_description | quote }}"
          - "untagged vlan {{ vlan_mapping[ansible_device_type] }}"
          - "speed-duplex auto"
          - "enable"

    - name: Apply phone-only config
      when: ansible_device_type == "phone"
      community.network.aruba_config:
        parents: "interface {{ ansible_port_number }}"
        lines:
          - "name {{ interface_description | quote }}"
          - "tagged vlan {{ vlan_mapping.phone }}"
          - "speed-duplex auto"
          - "enable"

    - name: Apply device + phone config
      when: ansible_second_device_type == "phone"
      community.network.aruba_config:
        parents: "interface {{ ansible_port_number }}"
        lines:
          - "name {{ interface_description | quote }}"
          - "untagged vlan {{ vlan_mapping[ansible_device_type] }}"
          - "tagged vlan {{ vlan_mapping.phone }}"
          - "speed-duplex auto"
          - "enable"

    - name: Disable port
      when: ansible_device_type == "none"
      community.network.aruba_config:
        parents: "interface {{ ansible_port_number }}"
        lines:
          - "name {{ interface_description | quote }}"
          - "disable"

    ###########################################################################
    # SAVE CONFIG
    ###########################################################################
    - name: Save configuration
      community.network.aruba_command:
        commands:
          - "write memory"
