---
###############################################################################
# PLAY 1 — Resolve switch and port (Survey-Driven)
###############################################################################
- name: Resolve switch and port
  hosts: localhost
  gather_facts: false

  vars:
    room: "{{ room | default('') }}"
    port_number: "{{ port_number | default('') }}"
    device_type: "{{ device_type | default('none') }}"
    second_device_type: "{{ second_device_type | default('none') }}"

  vars_files:
    - ../vars/switch_mapping.yml
    - ../vars/switch_ip_mapping.yml
    - ../vars/wall_point_mapping.yml
    - ../vars/vlan_mapping.yml

  tasks:
    - name: Validate room input
      fail:
        msg: "Room must be provided (Survey or -e room=...)"
      when: room | length == 0

    - name: Resolve switch from room
      set_fact:
        switch_name: "{{ item.key }}"
      loop: "{{ switch_mapping | dict2items }}"
      when: room | lower in (item.value | map('lower') | list)

    - name: Fail if switch not resolved
      fail:
        msg: "Room {{ room }} not mapped to any switch"
      when: switch_name is not defined

    - name: Resolve actual port number
      set_fact:
        actual_port_number: "{{ wall_point_mapping.get(port_number, port_number) }}"

    - name: Build interface description
      set_fact:
        interface_description: "N-G-{{ room | upper }}_{{ device_type }}"

    - name: Add resolved switch to runtime inventory
      add_host:
        name: "{{ switch_name }}"
        groups: dynamic_switches
        ansible_host: "{{ switch_ip_mapping[switch_name] }}"
        ansible_connection: network_cli
        ansible_network_os: arubaos_switch
        ansible_user: "{{ ansible_user }}"
        ansible_password: "{{ ansible_password }}"
        ansible_port_number: "{{ actual_port_number }}"
        ansible_device_type: "{{ device_type }}"
        ansible_second_device_type: "{{ second_device_type }}"
        interface_description: "{{ interface_description }}"

###############################################################################
# PLAY 2 — Configure Aruba switch port
###############################################################################
- name: Configure Aruba switch port
  hosts: dynamic_switches
  gather_facts: false
  connection: network_cli

  tasks:
    - name: Ensure interface enabled
      community.network.aruba_config:
        parents: "interface {{ ansible_port_number }}"
        lines:
          - "enable"

    - name: Clear VLANs
      community.network.aruba_config:
        parents: "interface {{ ansible_port_number }}"
        lines:
          - "no untagged vlan"
          - "no tagged vlan"

    - name: Apply device only
      when:
        - ansible_device_type != "none"
        - ansible_second_device_type == "none"
      community.network.aruba_config:
        parents: "interface {{ ansible_port_number }}"
        lines:
          - "name {{ interface_description }}"
          - "untagged vlan {{ vlan_mapping[ansible_device_type] }}"
          - "speed-duplex auto"
          - "enable"

    - name: Apply device + phone
      when: ansible_second_device_type == "phone"
      community.network.aruba_config:
        parents: "interface {{ ansible_port_number }}"
        lines:
          - "name {{ interface_description }}"
          - "untagged vlan {{ vlan_mapping[ansible_device_type] }}"
          - "tagged vlan {{ vlan_mapping.phone }}"
          - "speed-duplex auto"
          - "enable"

    - name: Disable port
      when: ansible_device_type == "none"
      community.network.aruba_config:
        parents: "interface {{ ansible_port_number }}"
        lines:
          - "name {{ interface_description }}_DISABLED"
          - "disable"

    - name: Save config
      community.network.aruba_command:
        commands:
          - "write memory"
